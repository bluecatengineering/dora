name: Issue Triage with Claude

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Analyze issue with Claude
        uses: actions/github-script@v7
        id: claude-triage
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          script: |
            const fetch = require('node-fetch');

            // Get issue details
            const issue = context.payload.issue;
            const issueTitle = issue.title;
            const issueBody = issue.body || 'No description provided';
            const issueNumber = issue.number;

            console.log(`Triaging issue #${issueNumber}: ${issueTitle}`);

            // Prepare prompt for Claude
            const prompt = `You are a helpful GitHub issue triage assistant for a Rust project called CRdora (a network control tool).

            Please analyze the following GitHub issue and provide a structured response:

            Title: ${issueTitle}

            Description:
            ${issueBody}

            Provide your analysis in the following format:

            SUMMARY: [1-2 sentence summary of the issue]

            LABELS: [comma-separated list of applicable labels from: bug, enhancement, feature, documentation, question, help-wanted, good-first-issue, performance, security, dependencies, breaking-change, needs-investigation]

            PRIORITY: [one of: critical, high, medium, low]

            ANALYSIS: [detailed analysis including:
            - What the issue is about
            - Potential impact
            - Suggested next steps or areas to investigate
            - Any relevant code observations if mentioned]

            Please be concise but thorough.`;

            // Call Anthropic API
            const response = await fetch('https://api.anthropic.com/v1/messages', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-api-key': process.env.ANTHROPIC_API_KEY,
                'anthropic-version': '2023-06-01'
              },
              body: JSON.stringify({
                model: 'claude-sonnet-4-5-20250929',
                max_tokens: 2048,
                messages: [{
                  role: 'user',
                  content: prompt
                }]
              })
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Anthropic API error: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            const triageResult = data.content[0].text;

            console.log('Triage result:', triageResult);

            // Save result for verification
            const fs = require('fs');
            fs.writeFileSync('triage_result.txt', triageResult);

            // Post comment on issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## ðŸ¤– Automated Issue Triage\n\n${triageResult}\n\n---\n*This analysis was generated by Claude AI. Please review and adjust labels/priority as needed.*`
            });

            // Extract and apply labels
            const labelsMatch = triageResult.match(/LABELS:\s*(.+)/i);
            if (labelsMatch) {
              const suggestedLabels = labelsMatch[1]
                .split(',')
                .map(label => label.trim().toLowerCase())
                .filter(label => label.length > 0);

              console.log('Suggested labels:', suggestedLabels);

              // Get existing repository labels
              const { data: repoLabels } = await github.rest.issues.listLabelsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo
              });

              const existingLabelNames = repoLabels.map(l => l.name.toLowerCase());

              // Only apply labels that exist in the repository
              const labelsToApply = suggestedLabels.filter(label =>
                existingLabelNames.includes(label)
              );

              if (labelsToApply.length > 0) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: labelsToApply
                });
                console.log('Applied labels:', labelsToApply);
              } else {
                console.log('No matching labels found in repository');
              }
            }

            // Extract priority and add as label if priority labels exist
            const priorityMatch = triageResult.match(/PRIORITY:\s*(\w+)/i);
            if (priorityMatch) {
              const priority = priorityMatch[1].toLowerCase();
              const priorityLabel = `priority:${priority}`;

              const { data: repoLabels } = await github.rest.issues.listLabelsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo
              });

              const existingLabelNames = repoLabels.map(l => l.name.toLowerCase());

              if (existingLabelNames.includes(priorityLabel)) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: [priorityLabel]
                });
                console.log('Applied priority label:', priorityLabel);
              }
            }

            return triageResult;

      - name: Upload triage result
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: triage-result
          path: triage_result.txt
          retention-days: 30
