# Automated Pull Request Review with Claude

This workflow automatically reviews pull requests using Claude AI (Anthropic), providing intelligent code review suggestions and analysis.

## Features

- **Automatic PR Analysis**: Claude reviews PRs when opened or updated
- **Code Review**: Analyzes diffs and provides constructive feedback
- **Security Scanning**: Identifies potential security concerns
- **Breaking Change Detection**: Flags potential breaking changes
- **Smart Labeling**: Automatically applies relevant labels
- **Testing Recommendations**: Suggests testing improvements
- **Artifact Retention**: Saves review results for 30 days

## Quick Setup

The PR review workflow uses the same setup as issue triage:

```bash
./setup/setup-issue-triage.sh
```

This will set up both issue triage and PR review workflows.

## What Gets Analyzed

Claude reviews:
- **PR Title and Description**: Understanding the intent
- **Code Changes**: The actual diff of all changed files
- **File Count and Change Statistics**: Scope of changes
- **Security Implications**: Potential vulnerabilities
- **Breaking Changes**: API or behavior changes
- **Test Coverage**: Whether tests are included/needed

## Review Output

For each PR, Claude provides:

### Summary
A 2-3 sentence overview of what the PR accomplishes

### Changes
Categorized list of main changes (features, bug fixes, refactoring, etc.)

### Concerns
Any potential issues, bugs, or areas needing attention

### Security Analysis
Security considerations or vulnerabilities identified

### Breaking Changes
Any changes that break existing APIs or behavior

### Testing Recommendations
Comments on test coverage and testing suggestions

### Improvement Suggestions
Constructive suggestions for code quality

### Labels
Automatic label suggestions from:
- `bug`, `enhancement`, `feature`
- `documentation`, `performance`, `security`
- `dependencies`, `breaking-change`
- `needs-tests`, `ready-to-merge`

## Example Output

```markdown
## ü§ñ Automated PR Review

SUMMARY: This PR adds support for IPv6 address configuration and
updates the network interface management to handle both IPv4 and
IPv6 addresses.

CHANGES:
- Feature: Added IPv6 address parsing and validation
- Enhancement: Updated NetworkConfig struct to support dual-stack
- Refactoring: Extracted address validation into separate module
- Documentation: Updated README with IPv6 examples

CONCERNS:
- The IPv6 parsing might not handle link-local addresses correctly
- Missing validation for IPv6 address ranges
- Error messages could be more descriptive

SECURITY: No security concerns identified. Input validation
appears appropriate for network addresses.

BREAKING_CHANGES: The NetworkConfig struct now requires an
address_family field. Existing code using NetworkConfig will need
updates.

TESTING: Good test coverage for basic IPv6 cases. Consider adding:
- Tests for edge cases (link-local, multicast)
- Integration tests with real network interfaces
- Tests for error conditions

SUGGESTIONS:
1. Consider using the `ipnetwork` crate for more robust IPv6 handling
2. Add validation for reserved IPv6 address ranges
3. Update error types to be more specific
4. Add examples showing IPv4/IPv6 dual-stack usage

LABELS: feature, breaking-change, needs-tests

---
*This review was generated by Claude AI. It's meant to assist human
reviewers, not replace them.*
```

Additionally, if breaking changes or security concerns are detected:

```markdown
‚ö†Ô∏è **Warning**: This PR may contain breaking changes. Please review
carefully before merging.
```

```markdown
üîí **Security Notice**: Potential security considerations identified.
Please review the security analysis above.
```

## Workflow Trigger

The workflow runs on:
- **PR opened**: New pull requests
- **PR synchronized**: New commits pushed to existing PR
- **PR reopened**: Previously closed PR is reopened

```yaml
on:
  pull_request:
    types: [opened, synchronize, reopened]
```

## Configuration

### Required Permissions

The workflow needs:
- **pull-requests: write** - To post review comments
- **contents: read** - To access repository code

### Required Secrets

- **ANTHROPIC_API_KEY** - Your Anthropic API key (same as issue triage)

### Diff Size Limits

To avoid overwhelming Claude and exceeding token limits:
- Maximum diff size: 15,000 characters
- Files are included in order until limit is reached
- Large PRs may have truncated diffs in the review

## Cost Considerations

- Claude Sonnet 4.5 pricing: ~$3 per million input tokens, ~$15 per million output tokens
- Average PR review: ~2,000 input tokens + ~800 output tokens
- Estimated cost per PR: ~$0.018 (less than 2 cents)
- For 50 PRs/month: ~$0.90

Very cost-effective for most repositories.

## Customization

### Change the Model

Edit `.github/workflows/pr-review.yml`:

```javascript
model: 'claude-sonnet-4-5-20250929',  // Current
// or
model: 'claude-opus-4-5-20250514',    // More capable but slower/pricier
model: 'claude-haiku-3-5-20241022',   // Faster and cheaper
```

### Customize Review Focus

Modify the prompt to emphasize different aspects:

```javascript
const prompt = `You are a helpful code reviewer...

Focus especially on:
- Performance implications
- Memory safety
- Error handling
- ...
`;
```

### Adjust Diff Size Limit

Change the character limit in the workflow:

```javascript
if (diffContent.length < 15000) {  // Increase or decrease
```

### Filter Which Files to Review

Add file filtering logic:

```javascript
for (const file of files) {
  // Skip test files
  if (file.filename.includes('test')) continue;

  // Only review Rust files
  if (!file.filename.endsWith('.rs')) continue;

  // ...
}
```

## Troubleshooting

### Workflow doesn't trigger

- Check workflow is on the default branch (`main` or `master`)
- Verify Actions are enabled in repository settings
- Check the PR is from the same repository (not a fork by default)

### Reviews are incomplete for large PRs

- The diff is truncated at 15,000 characters
- Consider splitting large PRs into smaller ones
- Or increase the limit in the workflow (may increase API costs)

### API errors

```
Error: Anthropic API error: 401
```

- Verify `ANTHROPIC_API_KEY` secret is set correctly
- Check API key is valid and has sufficient credits

### Labels not applied

- Labels must exist in the repository first
- Run the setup script to create standard labels
- Or create them manually

## Security & Privacy

- **PR code is sent to Anthropic's API** for analysis
- Don't use this workflow if PRs contain sensitive code
- API key is stored securely in GitHub Secrets
- Workflow has read-only access to repository contents
- Write access limited to pull requests only

## Advanced Usage

### Require Claude Review Before Merge

Add branch protection rules:
1. Go to repository **Settings** ‚Üí **Branches**
2. Add rule for your default branch
3. Enable "Require status checks to pass"
4. Add "PR Review with Claude" to required checks

### Auto-assign Reviewers Based on Analysis

Add to the workflow script:

```javascript
// Auto-assign based on file types
const hasRustChanges = files.some(f => f.filename.endsWith('.rs'));
const hasDocChanges = files.some(f => f.filename.endsWith('.md'));

if (hasRustChanges) {
  await github.rest.pulls.requestReviewers({
    owner: context.repo.owner,
    repo: context.repo.repo,
    pull_number: prNumber,
    reviewers: ['rust-expert-username']
  });
}
```

### Integration with Project Boards

Automatically add reviewed PRs to project boards:

```javascript
// After review is complete
if (labelsToApply.includes('ready-to-merge')) {
  // Add to "Ready for Merge" column
  await github.rest.projects.createCard({
    column_id: COLUMN_ID,
    content_id: pr.id,
    content_type: 'PullRequest'
  });
}
```

### Notify on Critical Issues

Send Slack/Discord notifications for critical findings:

```javascript
if (reviewResult.includes('SECURITY:') &&
    !reviewResult.includes('No security concerns')) {
  // Send notification to security team
  // Use Slack webhook, Discord webhook, etc.
}
```

## Combining with Other Tools

### With Conventional Commits

Check PR title format:

```javascript
const conventionalCommitPattern = /^(feat|fix|docs|style|refactor|perf|test|chore)(\(.+\))?: .+/;
if (!conventionalCommitPattern.test(prTitle)) {
  await github.rest.issues.createComment({
    owner: context.repo.owner,
    repo: context.repo.repo,
    issue_number: prNumber,
    body: '‚ö†Ô∏è PR title does not follow Conventional Commits format'
  });
}
```

### With Rust-specific Tools

Run `cargo clippy` and include results in context:

```yaml
- name: Run Clippy
  run: cargo clippy -- -D warnings 2>&1 | tee clippy.txt

- name: Include Clippy in Review
  # Pass clippy.txt content to Claude
```

## Maintenance

### Update Claude Model

When new models are released:

```bash
# Edit .github/workflows/pr-review.yml
# Update the model parameter
git commit -am "Update to latest Claude model"
git push
```

### Review Accuracy

Periodically check review artifacts:
1. Go to **Actions** ‚Üí **PR Review with Claude**
2. Download `pr-review-result` artifacts
3. Compare with actual code review outcomes
4. Adjust prompt if needed

## Uninstalling

Remove the workflow:

```bash
git rm .github/workflows/pr-review.yml
git commit -m "Remove PR review workflow"
git push
```

The issue triage workflow remains independent.

## FAQ

**Q: Will this replace human code review?**
A: No. Claude provides helpful analysis but human review is still essential.

**Q: What about PRs from forks?**
A: By default, workflows from forks have limited permissions. You may need to adjust workflow permissions or trigger conditions.

**Q: Can I use this for private repositories?**
A: Yes, but be aware that PR code is sent to Anthropic's API.

**Q: How long does review take?**
A: Typically 10-30 seconds depending on PR size.

**Q: Can I review PRs manually with Claude?**
A: Yes, the workflow can be triggered manually from the Actions tab.

## Support

For issues with:
- **The workflow**: Check workflow run logs in Actions tab
- **Claude API**: See [Anthropic documentation](https://docs.anthropic.com/)
- **GitHub Actions**: See [GitHub Actions documentation](https://docs.github.com/en/actions)

## References

- [ISSUE_TRIAGE.md](./ISSUE_TRIAGE.md) - Related issue triage workflow
- [Anthropic API Documentation](https://docs.anthropic.com/en/api/)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Claude Models](https://docs.anthropic.com/en/docs/models-overview)
